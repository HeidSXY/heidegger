<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Heidegger ‚Äî Interactive Safety Simulator</title>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  
  :root {
    --bg: #0a0c10;
    --surface: #12151c;
    --surface2: #1a1e28;
    --border: #2a2e3a;
    --text: #e4e8f0;
    --text-dim: #8890a0;
    --red: #e84040;
    --red-bg: rgba(232, 64, 64, 0.08);
    --red-border: rgba(232, 64, 64, 0.3);
    --green: #34d058;
    --green-bg: rgba(52, 208, 88, 0.08);
    --green-border: rgba(52, 208, 88, 0.3);
    --orange: #f0883e;
    --blue: #58a6ff;
    --mono: 'JetBrains Mono', monospace;
    --sans: 'Inter', -apple-system, sans-serif;
  }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: var(--sans);
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* ‚îÄ‚îÄ Header ‚îÄ‚îÄ */
  .header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px 24px;
    border-bottom: 1px solid var(--border);
    background: var(--surface);
  }
  .header h1 {
    font-size: 16px;
    font-weight: 700;
    letter-spacing: 0.5px;
  }
  .header h1 span { color: var(--blue); }
  .header .status {
    display: flex;
    align-items: center;
    gap: 8px;
    font-family: var(--mono);
    font-size: 12px;
    color: var(--text-dim);
  }
  .header .dot {
    width: 8px; height: 8px;
    border-radius: 50%;
    background: var(--green);
    animation: pulse 2s infinite;
  }
  .header .dot.disconnected { background: var(--red); animation: none; }
  @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }

  /* ‚îÄ‚îÄ Main Layout ‚îÄ‚îÄ */
  .main {
    display: grid;
    grid-template-columns: 1fr 1fr;
    grid-template-rows: auto 1fr;
    gap: 0;
    height: calc(100vh - 49px);
  }

  /* ‚îÄ‚îÄ Viewports ‚îÄ‚îÄ */
  .viewport {
    position: relative;
    background: #000;
    border: 1px solid var(--border);
    overflow: hidden;
  }
  .viewport.left { border-right: none; }
  .viewport img {
    width: 100%;
    height: 100%;
    object-fit: contain;
    display: block;
  }
  .viewport .label {
    position: absolute;
    top: 10px;
    left: 12px;
    font-family: var(--mono);
    font-size: 11px;
    font-weight: 600;
    padding: 4px 10px;
    border-radius: 4px;
    letter-spacing: 0.5px;
  }
  .viewport.left .label {
    background: var(--red-bg);
    border: 1px solid var(--red-border);
    color: var(--red);
  }
  .viewport.right .label {
    background: var(--green-bg);
    border: 1px solid var(--green-border);
    color: var(--green);
  }

  /* ‚îÄ‚îÄ Controls ‚îÄ‚îÄ */
  .controls-area {
    grid-column: 1 / -1;
    display: grid;
    grid-template-columns: 1fr 320px;
    border-top: 1px solid var(--border);
    background: var(--surface);
    max-height: 340px;
    overflow-y: auto;
  }

  .sliders-panel {
    padding: 16px 20px;
    display: flex;
    flex-direction: column;
    gap: 8px;
  }
  .sliders-panel h3 {
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 1.5px;
    color: var(--text-dim);
    margin-bottom: 4px;
  }

  .slider-row {
    display: grid;
    grid-template-columns: 110px 1fr 55px 55px;
    align-items: center;
    gap: 10px;
    height: 30px;
  }
  .slider-row label {
    font-family: var(--mono);
    font-size: 12px;
    color: var(--text-dim);
  }
  .slider-row input[type="range"] {
    -webkit-appearance: none;
    width: 100%;
    height: 4px;
    border-radius: 2px;
    background: var(--surface2);
    outline: none;
    cursor: pointer;
  }
  .slider-row input[type="range"]::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 14px; height: 14px;
    border-radius: 50%;
    background: var(--blue);
    cursor: grab;
    border: 2px solid var(--bg);
  }
  .slider-row input[type="range"]:active::-webkit-slider-thumb { cursor: grabbing; }
  .slider-row .val {
    font-family: var(--mono);
    font-size: 11px;
    text-align: right;
  }
  .slider-row .val.raw { color: var(--text-dim); }
  .slider-row .val.safe { color: var(--green); font-weight: 600; }
  .slider-row .val.clamped { color: var(--orange); font-weight: 600; }

  /* ‚îÄ‚îÄ Right Sidebar ‚îÄ‚îÄ */
  .sidebar {
    border-left: 1px solid var(--border);
    padding: 14px 16px;
    display: flex;
    flex-direction: column;
    gap: 14px;
    overflow-y: auto;
  }
  .sidebar h3 {
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 1.5px;
    color: var(--text-dim);
  }

  /* Status */
  .status-box {
    padding: 10px 12px;
    border-radius: 6px;
    font-family: var(--mono);
    font-size: 11px;
    line-height: 1.6;
  }
  .status-box.ok {
    background: var(--green-bg);
    border: 1px solid var(--green-border);
    color: var(--green);
  }
  .status-box.danger {
    background: var(--red-bg);
    border: 1px solid var(--red-border);
    color: var(--red);
  }
  .status-box.warning {
    background: rgba(240, 136, 62, 0.08);
    border: 1px solid rgba(240, 136, 62, 0.3);
    color: var(--orange);
  }

  /* Presets */
  .presets {
    display: flex;
    flex-direction: column;
    gap: 6px;
  }
  .preset-btn {
    font-family: var(--mono);
    font-size: 11px;
    padding: 7px 10px;
    border: 1px solid var(--border);
    border-radius: 5px;
    background: var(--surface2);
    color: var(--text);
    cursor: pointer;
    text-align: left;
    transition: all 0.15s;
  }
  .preset-btn:hover { border-color: var(--blue); color: var(--blue); }
  .preset-btn.danger { border-color: var(--red-border); }
  .preset-btn.danger:hover { border-color: var(--red); color: var(--red); }

  /* Noise toggle */
  .noise-row {
    display: flex; align-items: center; gap: 10px;
    font-size: 12px;
  }
  .noise-row input[type="checkbox"] {
    width: 16px; height: 16px;
    accent-color: var(--orange);
  }

  /* Perf */
  .perf {
    font-family: var(--mono);
    font-size: 10px;
    color: var(--text-dim);
    text-align: right;
    padding-top: 4px;
    border-top: 1px solid var(--border);
  }
</style>
</head>
<body>

<div class="header">
  <h1><span>HEIDEGGER</span> Interactive Safety Simulator</h1>
  <div class="status">
    <div class="dot" id="connDot"></div>
    <span id="connText">Connecting...</span>
  </div>
</div>

<div class="main">
  <!-- Left viewport: Raw / Ghost -->
  <div class="viewport left">
    <img id="imgGhost" alt="Raw simulation">
    <div class="label">üî¥ RAW ‚Äî No Protection</div>
  </div>

  <!-- Right viewport: Safe / Heidegger -->
  <div class="viewport right">
    <img id="imgSafe" alt="Safe simulation">
    <div class="label">üü¢ HEIDEGGER ‚Äî Protected</div>
  </div>

  <!-- Controls -->
  <div class="controls-area">
    <div class="sliders-panel">
      <h3>Joint Control</h3>
      <div class="slider-row">
        <label>base_rotation</label>
        <input type="range" id="s0" min="-3.14" max="3.14" step="0.01" value="0">
        <span class="val raw" id="v0">0.00</span>
        <span class="val safe" id="vs0">0.00</span>
      </div>
      <div class="slider-row">
        <label>shoulder</label>
        <input type="range" id="s1" min="-2.5" max="2.5" step="0.01" value="0">
        <span class="val raw" id="v1">0.00</span>
        <span class="val safe" id="vs1">0.00</span>
      </div>
      <div class="slider-row">
        <label>elbow</label>
        <input type="range" id="s2" min="-3.0" max="2.0" step="0.01" value="0">
        <span class="val raw" id="v2">0.00</span>
        <span class="val safe" id="vs2">0.00</span>
      </div>
      <div class="slider-row">
        <label>wrist_flex</label>
        <input type="range" id="s3" min="-2.5" max="2.5" step="0.01" value="0">
        <span class="val raw" id="v3">0.00</span>
        <span class="val safe" id="vs3">0.00</span>
      </div>
      <div class="slider-row">
        <label>wrist_roll</label>
        <input type="range" id="s4" min="-3.14" max="3.14" step="0.01" value="0">
        <span class="val raw" id="v4">0.00</span>
        <span class="val safe" id="vs4">0.00</span>
      </div>
      <div class="slider-row">
        <label>gripper</label>
        <input type="range" id="s5" min="-1.5" max="1.5" step="0.01" value="0">
        <span class="val raw" id="v5">0.00</span>
        <span class="val safe" id="vs5">0.00</span>
      </div>
    </div>

    <div class="sidebar">
      <div>
        <h3>Safety Status</h3>
        <div class="status-box ok" id="statusBox">
          ‚úÖ All clear ‚Äî no violations
        </div>
      </div>

      <div>
        <h3>Preset Scenarios</h3>
        <div class="presets">
          <button class="preset-btn" onclick="applyPreset('home')">üè† Home Position</button>
          <button class="preset-btn" onclick="applyPreset('reach')">‚úã Normal Reach</button>
          <button class="preset-btn danger" onclick="applyPreset('table')">‚ö†Ô∏è Á©øÊ°å: Arm Into Table</button>
          <button class="preset-btn danger" onclick="applyPreset('reverse')">‚ö†Ô∏è ÂèçÂÖ≥ËäÇ: Reverse Elbow</button>
          <button class="preset-btn danger" onclick="applyPreset('selfhit')">‚ö†Ô∏è Ëá™Á¢∞Êíû: Gripper Into Base</button>
          <button class="preset-btn danger" onclick="applyPreset('spin')">‚ö†Ô∏è ÁåõËΩ¨: Extreme Rotation</button>
        </div>
      </div>

      <div>
        <div class="noise-row">
          <input type="checkbox" id="noiseToggle">
          <label for="noiseToggle">Auto VLA Noise Injection</label>
        </div>
      </div>

      <div class="perf" id="perf">‚Äî</div>
    </div>
  </div>
</div>

<script>
const JOINTS = ['base_rotation','shoulder','elbow','wrist_flex','wrist_roll','gripper'];
const PRESETS = {
  home:    [0, 0, 0, 0, 0, 0],
  reach:   [0.3, 0.6, -1.2, 0.3, 0, 0.5],
  table:   [0.3, 1.8, -0.3, 0.5, 0, 0.3],
  reverse: [0, 0.5, 1.8, -0.5, 0, 0.3],
  selfhit: [0, 1.0, -2.3, -1.5, 0, 0.3],
  spin:    [5.0, 0.8, -0.5, 0, 3.0, 0.5],
};

let ws = null;
let sending = false;
let pendingAngles = null;
let noiseInterval = null;

function connect() {
  const proto = location.protocol === 'https:' ? 'wss:' : 'ws:';
  ws = new WebSocket(`${proto}//${location.host}/ws`);
  
  ws.onopen = () => {
    document.getElementById('connDot').classList.remove('disconnected');
    document.getElementById('connText').textContent = 'Connected';
    sendAngles();
  };

  ws.onmessage = (evt) => {
    const data = JSON.parse(evt.data);
    
    // Update images
    document.getElementById('imgGhost').src = 'data:image/jpeg;base64,' + data.ghost;
    document.getElementById('imgSafe').src = 'data:image/jpeg;base64,' + data.safe;

    // Update safe angle displays
    if (data.safe_angles) {
      for (let i = 0; i < 6; i++) {
        const el = document.getElementById('vs' + i);
        const raw = parseFloat(document.getElementById('s' + i).value);
        const safe = data.safe_angles[i];
        el.textContent = safe.toFixed(2);
        
        if (Math.abs(raw - safe) > 0.02) {
          el.className = 'val clamped';
        } else {
          el.className = 'val safe';
        }
      }
    }

    // Update status
    const box = document.getElementById('statusBox');
    let lines = [];
    
    if (data.has_collision) {
      data.collisions.forEach(c => {
        lines.push(`üí• ${c.a} ‚Üî ${c.b}: ${c.dist}mm`);
      });
    }
    if (data.violations && data.violations.length > 0) {
      data.violations.forEach(v => {
        lines.push(`üîí ${v.joint}: ${v.original.toFixed(2)} ‚Üí ${v.clamped.toFixed(2)} (${v.reason})`);
      });
    }

    if (data.has_collision) {
      box.className = 'status-box danger';
      box.innerHTML = lines.join('<br>');
    } else if (data.was_clamped) {
      box.className = 'status-box warning';
      box.innerHTML = lines.join('<br>');
    } else {
      box.className = 'status-box ok';
      box.innerHTML = '‚úÖ All clear ‚Äî no violations';
    }

    // Perf
    document.getElementById('perf').textContent = `Safety: ${data.safety_us}Œºs`;

    // Send next if pending
    sending = false;
    if (pendingAngles) {
      const a = pendingAngles;
      pendingAngles = null;
      sendRaw(a);
    }
  };

  ws.onclose = () => {
    document.getElementById('connDot').classList.add('disconnected');
    document.getElementById('connText').textContent = 'Disconnected ‚Äî retrying...';
    setTimeout(connect, 2000);
  };
}

function sendRaw(angles) {
  if (!ws || ws.readyState !== WebSocket.OPEN) return;
  if (sending) {
    pendingAngles = angles;
    return;
  }
  sending = true;
  ws.send(JSON.stringify({ type: 'angles', angles }));
}

function getAngles() {
  return Array.from({length: 6}, (_, i) => parseFloat(document.getElementById('s'+i).value));
}

function sendAngles() {
  const angles = getAngles();
  sendRaw(angles);
}

// Slider events
for (let i = 0; i < 6; i++) {
  const slider = document.getElementById('s' + i);
  slider.addEventListener('input', () => {
    document.getElementById('v' + i).textContent = parseFloat(slider.value).toFixed(2);
    sendAngles();
  });
}

// Presets
function applyPreset(name) {
  const vals = PRESETS[name];
  if (!vals) return;
  for (let i = 0; i < 6; i++) {
    const slider = document.getElementById('s' + i);
    slider.value = vals[i];
    document.getElementById('v' + i).textContent = vals[i].toFixed(2);
  }
  sendAngles();
}

// Noise injection
document.getElementById('noiseToggle').addEventListener('change', (e) => {
  if (e.target.checked) {
    noiseInterval = setInterval(() => {
      const angles = getAngles();
      const noisy = angles.map(a => a + (Math.random() - 0.5) * 0.6);
      // Occasional big spike
      if (Math.random() < 0.15) {
        const j = Math.floor(Math.random() * 6);
        noisy[j] += (Math.random() - 0.5) * 4.0;
      }
      for (let i = 0; i < 6; i++) {
        document.getElementById('s' + i).value = noisy[i];
        document.getElementById('v' + i).textContent = noisy[i].toFixed(2);
      }
      sendRaw(noisy);
    }, 80);
  } else {
    if (noiseInterval) clearInterval(noiseInterval);
    noiseInterval = null;
  }
});

// Start
connect();
</script>
</body>
</html>
